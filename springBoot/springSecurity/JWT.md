# JWT (Json Web Token)

## JWT 란?

`JWT`는 통신 양자간에 정보를 `JSON`형식을 사용하여 안전하게 전송하기 위한 방법이다. `JWT`는 `HMAC`나 `RSA`, `ECDSA`을 사용하여 공개/개인 키 쌍을 사용하여 서명되어진다. 해시 혹은 비대칭키 방식을 사용하여 서명되기 대문에 무결성을 검증할 수 있으며, 토큰 자체에 정보가 포함되어 있기 때문에 통신 양자간에 정보를 안전하게 전송하는것이 가능하다.
<br/>

`JWT`는 인증(`Authentication`)과 권한부여(`Authorization`)에 주로 사용된다. 사용자가 로그인했을 때 인증 절차를 거쳐 서버에서 `JWT`를 발급해주면, 클라이언트가 이를 보관하게 된다. 후속 요청으로 API등을 사용하게 될 때에 서버에 `JWT`를 함께 제출되어 해당 토큰으로 허용되는 경로, 서비스 및 리소스에 접근할 수 있게 된다.
<br/>

`JWT`는 정보교환의 목적으로도 사용되는데, 공개/개인 키 쌍을 사용해야만 `JWT`에 서명할 수 있게 함으로써 보낸 사람이 누구인지 확인할 수 있다. 뿐만 아니라 `Header`및 `payload`를 사용하여 콘텐츠의 변조여부 또한 확인할 수 있다.

> HMAC : 암호화 해시 함수와 기밀 암호화 키를 수반하는 특정한 유형의 메시지 인증 코드

## 토큰 기반 인증이란?

토큰기반의 인증방식은 유저의 정보를 서버에 저장하지 않는다. 유저가 성공적으로 로그인했을 때, 서버는 클라이언트로 토큰을 발급한다. 이때 클라이언트는 토큰을 받아 저장한 후 서버에 요청이 들어왔을때 HTTP header에 실어 함께 전송한다. 이때 서버는 이를 검증하고 유저를 인가하게 된다. 이처럼 서버는 발급과 인증 두 가지 역할만을 수행하게 되며 정보를 직접 가지고 있지는 않는다

## JWT 구조

JSON 웹 토큰은 `.`을 경계로 머리글, 페이로드, 서명 세 부분으로 구성된다. 

`iiiii.jjjjj.kkkkk`

### 1. 헤더

**헤더**는 토큰 유형(`JWT`)과 사용되는 서명 알고리즘의 두 부분으로 구성된다. 

```json
    {
        "alg": "HS256",
        "typ": "JWT"
    }
```
위와 같은 `JSON`형태가 Base64Url을 통해 인코딩 되어 `JWT`의 헤더 부분을 구성하게 된다.

### 2. 페이로드
**페이로드**는 클레임(엔터티 및 추가 데이터에 대한 설명 / =청구)을 포함한다. 클레임은 등록된 클레임, 공개 클레임, 비공개 클레임 3가지로 구분할 수 있다

* 등록된 클레임 : `JWT`사양에 이미 정의된 클레임으로, 7개의 클레임이 선택적으로 정의되어 있다. `JWT`를 압축하기 위해 3글자로 제한되어 있다
    * `iss`: 토큰 발급자 (Issuer)
    * `sub`: 토큰 제목 (Subject)
    * `aud`: 토큰 대상자 (Audience)
    * `exp`: 토큰 만료시간 (Expireation Time)
    * `nbf`: 토큰의 활성 시간 (Not Before)
    * `iat`: 토큰이 발급된 시간 (Issued At)
    * `jti`: `JWT`의 식별자 (JWT ID)
<br/>

* 공개 클레임 : 서버-클라이언트 간의 통신외에 3자 또한 `JWT`토큰을 사용할 때 충돌이 일어나지 않도록 합의된 클레임이다. `IANA JSON`웹 토큰 레지스트리에 정의하거나, 충돌방지 네임스페이스를 포함하는 URI로 정의해야 한다.
<br/>

* 비공개 클레임 : 서버-클라이언트 간에서만 협의된 클레임으로, 등록되거나 공개되지 않은 클레임이다.
    ```json
    {
        "Sub": "1234567890",
        "name": "Gil Dong",
        "admin": true
    }
    ```

페이로드 또한 Base64Url로 인코딩 되어 `JWT`의 두번째 부분을 구성하게 된다.

### 3. 서명

**서명**부분은 헤더에 지정된 암호화 알고리즘, 인코딩된 헤더 및 페이로드, 비밀키를 이용하여 암호화된다. 

* 예 - HMAC SHA256알고리즘을 사용하는 경우의 서명
```
    HMACSHA256(
    base64UrlEncode(header) + "." +
    base64UrlEncode(payload),
    secret
    )
```
서명을 통해 메시지가 도중에 변경되지 않았는지 확인할 수 있으며, 개인 키로 서명된 토큰의 경우 JWT의 보낸 사람이 누구인지 확인할 수도 있다

### 4. 토큰

![JWT 토큰](../resource/JWT/JWT.JPG)

## 작동

토큰을 사용하게 될 경우 보안 문제가 발생할 경우를 대비하여 오래 보관해서는 안되며, 민감한 세션데이터를 브라우저 저장소에 저장해서는 안되나. 일반적으로 `Bearer`스키마를 사용하여 `Authorization`헤더에 `JWT`를 보낸다.

```json
    Autorization: Bearer <token>
```

API 또는 리소스에 액세스하기 위해 JWT를 획득하고 사용하는 방법은 다음과 같다.

![JWT작동/출처:https://jwt.io/introduction](../../resource/JWT/client-credentials-grant.png)

1. 애플리케이션 또는 클라이언트가 인증 요청을 보낸다.
2. 권한이 부여되면 권한 서버는 애플리케이션에 액세스 토큰을 반환한다.
3. 애플리케이션은 액세스 토큰을 사용하여 보호된 리소스에 액세스 한다.

# 참조

* https://jwt.io/introduction
* https://hudi.blog/self-made-jwt/